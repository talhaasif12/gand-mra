<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Teacher Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="data.js"></script>
</head>
<body>
    <header>
        <h1>Teacher Portal</h1>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </header>

    <div class="container">
        
        <!-- 1. NOTIFICATIONS -->
        <div class="card">
            <h2>Broadcast Announcement</h2>
            <textarea id="msg-txt" rows="2" placeholder="Send a message to all students..."></textarea>
            <button onclick="sendMsg()" style="width:auto;">Send Message</button>
        </div>

        <!-- 2. COURSE SELECTION -->
        <div class="card">
            <h2>Class Management</h2>
            <div class="form-grid">
                <div>
                    <label>Select Course</label>
                    <select id="course-select" onchange="loadStudents()"></select>
                </div>
                <div>
                    <label>Select Student</label>
                    <select id="student-select" onchange="loadStats()"></select>
                </div>
            </div>
        </div>

        <!-- 3. ACTIONS -->
        <div class="card" id="action-area" style="display:none;">
            <h3>Perform Actions</h3>
            <div class="form-grid">
                <!-- Attendance -->
                <div style="background:#f9fcfb; padding:20px; border-radius:10px; border:1px solid #e0e0e0;">
                    <label>Attendance Status</label>
                    <select id="att-status"><option>Present</option><option>Absent</option></select>
                    <button onclick="saveAtt()">Mark Attendance</button>
                </div>
                <!-- Results -->
                <div style="background:#f9fcfb; padding:20px; border-radius:10px; border:1px solid #e0e0e0;">
                    <label>Upload Marks</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <input type="number" id="q" placeholder="Quiz">
                        <input type="number" id="a" placeholder="Assign">
                        <input type="number" id="m" placeholder="Mid">
                        <input type="number" id="f" placeholder="Final">
                    </div>
                    <button onclick="saveRes()">Upload Result</button>
                </div>
            </div>
            
            <div style="margin-top:20px; font-weight:bold; color:#11998e; font-size:16px;">
                Current Status: Attendance: <span id="v-att">0%</span> | Grade: <span id="v-grade">-</span>
            </div>
        </div>
    </div>

    <script>
        const user = checkSession('teacher');

        function loadCourses() {
            const all = getAllCourses();
            const myCourses = all.filter(c => c.teacherId === user.id);
            const sel = document.getElementById('course-select');
            
            if(myCourses.length === 0) sel.innerHTML = "<option>No Courses Assigned</option>";
            else {
                sel.innerHTML = "<option value=''>Select Course</option>";
                myCourses.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name} (${c.program}-${c.section})</option>`);
            }
        }

        function loadStudents() {
            const cId = parseInt(document.getElementById('course-select').value);
            const area = document.getElementById('action-area');
            const sSel = document.getElementById('student-select');
            
            if(!cId) { area.style.display='none'; return; }
            
            const regs = getAllRegs().filter(r => r.courseId === cId);
            const users = getAllUsers();
            
            sSel.innerHTML = "<option value=''>Select Student</option>";
            regs.forEach(r => {
                const s = users.find(u => u.id === r.studentId);
                if(s) sSel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
            });
            area.style.display = 'block';
        }

        function saveAtt() {
            const cId = parseInt(document.getElementById('course-select').value);
            const sId = document.getElementById('student-select').value;
            if(!sId) return alert("Select Student");
            
            let list = JSON.parse(localStorage.getItem('portal_att_v20')) || [];
            const date = new Date().toLocaleDateString();
            list = list.filter(x => !(x.courseId === cId && x.studentId === sId && x.date === date));
            list.push({ courseId: cId, studentId: sId, date: date, status: document.getElementById('att-status').value });
            localStorage.setItem('portal_att_v20', JSON.stringify(list));
            alert("Attendance Marked");
            loadStats();
        }

        function saveRes() {
            const cId = parseInt(document.getElementById('course-select').value);
            const sId = document.getElementById('student-select').value;
            if(!sId) return alert("Select Student");

            let list = JSON.parse(localStorage.getItem('portal_marks_v20')) || [];
            list = list.filter(x => !(x.courseId === cId && x.studentId === sId));
            list.push({
                courseId: cId, studentId: sId,
                q: Number(document.getElementById('q').value),
                a: Number(document.getElementById('a').value),
                m: Number(document.getElementById('m').value),
                f: Number(document.getElementById('f').value)
            });
            localStorage.setItem('portal_marks_v20', JSON.stringify(list));
            alert("Result Uploaded");
            loadStats();
        }

        function sendMsg() {
            const txt = document.getElementById('msg-txt').value;
            if(txt) { sendNotification(txt, user.name); alert("Sent"); document.getElementById('msg-txt').value=""; }
        }

        function loadStats() {
            const cId = parseInt(document.getElementById('course-select').value);
            const sId = document.getElementById('student-select').value;
            
            const allAtt = JSON.parse(localStorage.getItem('portal_att_v20')) || [];
            const cAtt = allAtt.filter(a => a.courseId === cId && a.studentId === sId);
            const present = cAtt.filter(a => a.status === 'Present').length;
            const perc = cAtt.length ? Math.round((present/cAtt.length)*100) : 0;

            document.getElementById('v-att').innerText = perc + "%";
        }

        loadCourses();
    </script>
</body>
</html>